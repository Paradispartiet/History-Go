<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <title>History Go – Din kunnskapsprofil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="knowledge.css">
</head>

<body class="knowledge-page">

  <header class="knowledge-header">
    <a class="back-link" href="profile.html">← Tilbake til profil</a>

    <img src="bilder/ui/historygo_logo.PNG" class="knowledge-logo" alt="History Go logo">

    <h1>Din kunnskapsprofil</h1>
    <p>All kunnskapen du har låst opp gjennom quiz – sortert etter felt og dimensjon.</p>
  </header>

  <!-- DINE BEGREPER -->
  <section class="know-block">
    <h2>Dine begreper</h2>
    <div id="conceptCloud"></div>
  </section>

  <!-- EMNE-DEKNING -->
  <section id="emneDekningSection" class="emne-dekning"></section>

  <!-- FILTER -->
  <section class="knowledge-filters">
    <select id="filterCategory">
      <option value="">Alle felt</option>
    </select>

    <select id="filterDimension">
      <option value="">Alle dimensjoner</option>
    </select>
  </section>

  <!-- LISTE OVER KUNNSKAPSPUNKTER -->
  <main id="knowledgeContainer"></main>

    <script src="knowledge.js"></script>
  <script src="js/hgInsights.js"></script>
  <script src="emnerLoader.js"></script> <!-- NY: felles loader for emner -->

  <!-- 1) Kunnskapsliste + filter -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const box   = document.getElementById("knowledgeContainer");
      const catF  = document.getElementById("filterCategory");
      const dimF  = document.getElementById("filterDimension");

      const uni = getKnowledgeUniverse();

      if (!uni || Object.keys(uni).length === 0) {
        box.innerHTML = `<div class="empty-note">Ingen kunnskap låst opp ennå.</div>`;
        return;
      }

      // Fyll kategori-filteret
      Object.keys(uni).forEach(cat => {
        const o = document.createElement("option");
        o.value = cat;
        o.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
        catF.appendChild(o);
      });

      // Fyll dimensjons-filteret
      const allDims = new Set();
      Object.values(uni).forEach(dimObj => {
        Object.keys(dimObj).forEach(d => allDims.add(d));
      });

      [...allDims].forEach(dim => {
        const o = document.createElement("option");
        o.value = dim;
        o.textContent = dim.charAt(0).toUpperCase() + dim.slice(1);
        dimF.appendChild(o);
      });

      function render() {
        const catSel = catF.value;
        const dimSel = dimF.value;

        let html = "";

        for (const [cat, dimObj] of Object.entries(uni)) {
          if (catSel && catSel !== cat) continue;

          let catBlock = "";
          let hasContent = false;

          for (const [dim, items] of Object.entries(dimObj)) {
            if (dimSel && dimSel !== dim) continue;
            if (!items || !items.length) continue;

            hasContent = true;

            catBlock += `
              <div class="dimension-title">${dim}</div>
              ${items
                .map(item => `
                  <div class="knowledge-item">
                    <div class="knowledge-topic">${item.topic}</div>
                    <div class="knowledge-text">${item.text}</div>
                  </div>
                `)
                .join("")}
            `;
          }

          if (hasContent) {
            html += `
              <section class="know-cat-block">
                <h2>${cat}</h2>
                ${catBlock}
              </section>
            `;
          }
        }

        box.innerHTML = html || `<div class="empty-note">Ingen treff.</div>`;
      }

      catF.onchange = render;
      dimF.onchange = render;
      render();
    });
  </script>

  <!-- 2) Begrepssky -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if (!window.HGInsights) return;

      const userId =
        (window.getCurrentUserId && getCurrentUserId()) || "anon";
      const concepts = HGInsights.getUserConcepts(userId);

      const box = document.getElementById("conceptCloud");
      if (!concepts.length) {
        box.innerHTML = "<p>Ingen begreper registrert ennå. Prøv noen quizer!</p>";
        return;
      }

      box.innerHTML = `
        <div class="hg-concept-cloud">
          ${concepts
            .slice(0, 50)
            .map(
              (c) => `
            <span class="hg-concept-pill" title="Brukt ${c.count} ganger">
              ${c.label}
            </span>
          `
            )
            .join("")}
        </div>
      `;
    });
  </script>

  <!-- 3) Emne-dekning – nå via EmnerLoader, flere felt -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const box = document.getElementById("emneDekningSection");
      if (!box) return;

      if (
        !window.HGInsights ||
        !window.computeEmneDekning ||
        !window.Emner
      ) {
        box.innerHTML = "<p class='muted'>Emne-dekning er ikke tilgjengelig ennå.</p>";
        return;
      }

      const userId =
        (window.getCurrentUserId && getCurrentUserId()) || "anon";
      const concepts =
        HGInsights.getUserConcepts(userId) || [];

      if (!concepts.length) {
        box.innerHTML = "<p class='muted'>Ta noen quizer for å se emne-dekning her.</p>";
        return;
      }

      // Hvilke felt vi vil måle emne-dekning på
      const SUBJECTS = [
        "vitenskap",
        "psykologi",
        "subkultur",
        "historie",
        "by",
        "kunst",
        "musikk",
        "natur",
        "litteratur",
        "naeringsliv",
        "sport",
        "politikk",
        "populaerkultur"
      ];

      let html = `<h2>Emne-dekning</h2>`;

      for (const subjectId of SUBJECTS) {
        const emner = await Emner.loadForSubject(subjectId);
        if (!emner || !emner.length) continue;

        const result = computeEmneDekning(concepts, emner);
        const nonEmpty = result.filter(r => r.total > 0);
        if (!nonEmpty.length) continue;

        const label = subjectId.charAt(0).toUpperCase() + subjectId.slice(1);

        html += `
          <section class="emne-dekning-blokk">
            <h3>${label}</h3>
            <ul class="emne-list">
              ${nonEmpty
                .map(r => `
                  <li class="emne-item">
                    <div class="emne-header">
                      <strong>${r.title}</strong>
                      <small>${r.percent}% dekket (${r.matchCount}/${r.total})</small>
                    </div>
                    <div class="bar-bg">
                      <div class="bar" style="width:${r.percent}%;"></div>
                    </div>
                  </li>
                `)
                .join("")}
            </ul>
          </section>
        `;
      }

      if (!html.includes("emne-item")) {
        html += `<p class="muted">Ingen emne-dekning å vise ennå. Ta flere quizer for å dekke emner i dybden.</p>`;
      }

      box.innerHTML = html;
    });
  </script>

</body>
</html>
