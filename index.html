<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>History Go</title>

  <!-- CSS -->
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/search.css">
  <link rel="stylesheet" href="css/nearby.css">
  <link rel="stylesheet" href="css/miniProfile.css">
  <link rel="stylesheet" href="css/profile.css">
  <link rel="stylesheet" href="css/merits.css">
  <link rel="stylesheet" href="css/quiz.css">
  <link rel="stylesheet" href="css/popups.css">
  <link rel="stylesheet" href="css/overlay.css">
  <link rel="stylesheet" href="css/effects.css">
  <link rel="stylesheet" href="css/map.css">
  <link rel="stylesheet" href="css/placeCard.css">
  <link rel="stylesheet" href="css/sheets.css">

  <!-- Console CSS -->
  <link rel="stylesheet" href="js/console/console.css">

  <!-- MapLibre CSS -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.css">
</head>

<body class="hg-app">

  <!-- Toast -->
  <div id="toast"></div>

  <!-- USYNLIGE DATA-CONTAINERE -->
  <div id="collectionGrid" style="display:none"></div>
  <div id="collectionCount" style="display:none"></div>
  <div id="gallery" style="display:none"></div>

  <!-- Badge-modal -->
  <div id="badgeModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content">
      <img class="badge-img" src="" alt="Merke">
      <h3 class="badge-title"></h3>
      <p class="badge-level"></p>
      <div class="badge-progress"><div class="badge-progress-bar"></div></div>
      <p class="badge-progress-text"></p>
      <ul class="badge-quizzes"></ul>
      <button class="close-btn">Lukk</button>
    </div>
  </div>

  <!-- KART -->
  <div id="map" aria-label="Kart"></div>

  <div class="map-controls">
    <button id="btnCenter" title="Sentrer">‚åñ</button>
    <button id="btnExitMap" title="Lukk kart" aria-label="Lukk kart">‚úï</button>
  </div>

<!-- HEADER -->
<header class="site-header">

  <img class="hg-brand" src="bilder/logo_historygo.PNG" alt="History GO">
  
  <div class="top-actions">
    <button id="btnSeeMap" class="secondary" type="button">Kartmodus</button>

    <input id="globalSearch" type="search" placeholder="S√∏k‚Ä¶" autocomplete="off">

    <span id="geoStatus" class="geo-status geo-unknown" title="Posisjonstatus">‚Ä¶</span>

    <button id="btnUnlockAll" class="secondary" style="display:none;" type="button">
      UnlockAll
    </button>

    <label class="toggle">
      <input id="openToggle" type="checkbox" />
      <span></span>
    </label>
  </div>

  <!-- S√òKERESULTATER (ligger fortsatt i headeren, men kan styles til √• droppe ned) -->
  <div id="searchResults"></div>

</header>

  <!-- VENSTRE RAMMEPANEL -->
<div id="nearbyListContainer" class="leftpanel">

    <div class="leftpanel-head">
    <div class="leftpanel-title">Utforsk</div>

    <div class="nearby-row1">
  <div class="nearby-tabs" role="tablist" aria-label="Utforsk">
    <button class="nearby-tab is-active" data-leftmode="nearby" type="button">Steder</button>
    <button class="nearby-tab" data-leftmode="people" type="button">Folk</button>
    <button class="nearby-tab" data-leftmode="nature" type="button">Natur</button>
    <button class="nearby-tab" data-leftmode="routes" type="button">Ruter</button>
    <button class="nearby-tab" data-leftmode="badges" type="button">Merker</button>
  </div>
      <!-- behold select i DOM skjult for bakoverkomp (JS kan fortsatt bruke den om du vil) -->
      <select id="leftPanelMode" class="leftpanel-select" aria-label="Velg visning" style="display:none">
        <option value="nearby" selected>N√¶rmeste</option>
        <option value="people">Folk</option>
        <option value="nature">Natur</option>
        <option value="routes">Ruter</option>
        <option value="badges">Merker</option>
      </select>

    </div> <!-- /nearby-row1 -->
  </div>   <!-- /leftpanel-head  ‚úÖ DENNE MANGLER HOS DEG -->

  <div class="leftpanel-body">
  <!-- 1) N√¶rmeste -->
  <section id="panelNearby" class="leftpanel-view">
    <!-- status beholdes for logging/feils√∏k, men skjules visuelt -->
    <div id="status" class="muted" style="display:none">Henter posisjon‚Ä¶</div>

    <div class="nearby-row2">
      <div id="nearbyList" class="nearby-strip"></div>
    </div>
  </section>

<!-- 2) People -->
<section id="panelPeople" class="leftpanel-view" style="display:none;">
  <div class="leftpanel-hint muted">People (kommer).</div>
  <div id="leftPeopleList" class="leftpanel-list"></div>
</section>

<!-- 3) Natur -->
<section id="panelNature" class="leftpanel-view" style="display:none;">
  <div class="leftpanel-hint muted">Natur (kommer).</div>
  <div id="leftNatureList" class="leftpanel-list"></div>
</section>
    
  <!-- 4) Ruter -->
  <section id="panelRoutes" class="leftpanel-view" style="display:none;">
    <div class="leftpanel-hint muted">Velg en rute, eller √•pne rutearket.</div>
    <button class="chip ghost" onclick="openRoutesSheet()">√Öpne ruter</button>
    <div id="leftRoutesList" class="leftpanel-list"></div>
  </section>
    
  <!-- 5) Merker -->
  <section id="panelBadges" class="leftpanel-view" style="display:none;">
    <div class="leftpanel-hint muted">Velg en kategori.</div>
    <div id="leftBadgesList" class="leftpanel-list"></div>
  </section>

  </section>

  
</div>
</div>

  <!-- PLACE CARD -->
<div id="placeCard" aria-hidden="true">
  <div class="pc-body">

    <!-- INNHOLD (IKKE SCROLL) -->
    <div class="pc-scroll">
      <div class="pc-main">
        <img id="pcImage" class="pc-img" src="" alt="">
        <div class="pc-text">
          <h2 id="pcTitle"></h2>
          <div id="pcMeta" class="pc-meta"></div>
          <p id="pcDesc" class="pc-desc"></p>
        </div>
      </div>

      <div id="pcPeople" class="pc-people"></div>
    </div>

    
    <!-- FAST BUNN -->
    <div class="pc-footer">
      
<!-- Footer stack: miniProfile over NextUp (full bredde) -->
<div class="pc-footer-stack">

  <a id="miniProfile" class="panel mini-profile mini-profile--link" href="profile.html">
    <div class="info">
      <div class="profile-top">
        <h3 id="miniName">Utforsker #182</h3>
      </div>

      <p id="miniStats" class="muted">
        <span id="linkPlaces" class="linkish">0 steder</span> ¬∑
        <span id="linkBadges" class="linkish">0 merker</span> ¬∑
        <span id="linkQuiz" class="linkish">0 quizzer</span>
      </p>

      <div id="miniBadges" class="profile-badges"></div>

      <div id="miniLastQuiz" class="profile-last-quiz" style="display:none;">
        <img id="miniLastQuizImg" src="">
        <span id="miniLastQuizName"></span>
      </div>
    </div>
  </a>

  <!-- NextUp under miniProfile -->
  <div id="mpNextUp" class="pc-nextup"></div>

</div>

<div class="pc-actions">
        <button id="pcInfo"    class="secondary">Mer info</button>
        <button id="pcQuiz"    class="primary">Ta quiz</button>
        <button id="pcUnlock"  class="primary">L√•s opp</button>
        <button id="pcRoute"   class="ghost">Rute</button>

        <button id="pcObserve" class="ghost pc-iconbtn" aria-label="Observasjon" title="Observasjon">üëÅÔ∏è</button>
        <button id="pcNote"    class="ghost pc-iconbtn" aria-label="Notat" title="Notat">üìù</button>
        <button id="pcClose" class="ghost"
          
          onclick="document.getElementById('placeCard').setAttribute('aria-hidden','true')">‚úï</button>

      <div class="brand brand-icononly">
    <img class="brand-logo" src="bilder/logo_historygo.PNG" alt="History GO">
  </div>
      
</div>
      
      </div>


      
</div>

  </div>
</div>
  <!-- SERVICE WORKER -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        const base = location.pathname.replace(/\/[^\/]*$/, "/");
        navigator.serviceWorker.register(base + "sw.js");
      });
    }
  </script>


  
  <!-- MapLibre JS: M√Ö f√∏r map.js -->
<script src="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.js"></script>

<script>
  window.addEventListener("error", (e) => {
    console.log("[GLOBAL ERROR]", {
      message: e.message,
      filename: e.filename,
      lineno: e.lineno,
      colno: e.colno
    });
  });

  window.addEventListener("unhandledrejection", (e) => {
    console.log("[UNHANDLED REJECTION]", e.reason);
  });

</script>

<!-- Dine moduler -->
<script src="js/popup-utils.js"></script>
<script src="/js/hgchips.js" defer></script>
<script src="js/knowledge.js"></script>
<script src="js/knowledge_component.js"></script>
<script src="js/trivia.js"></script>
<script src="js/hgInsights.js"></script>
<script src="js/dataHub.js"></script>

<script src="js/domainRegistry.js"></script>
<script src="js/domainHealthReport.js"></script>
  
<script src="js/console/init.js"></script>
<script src="js/console/verify.js"></script>
<script src="js/console/diagnosticConsole.js"></script>
<script src="js/console/devConsole.js"></script>
<script src="js/console/legacyExtensions.js"></script>

<script src="js/audits/missingImages.audit.js"></script>

<script src="js/observations.js"></script>
<script src="js/observationsView.js"></script>

<script src="js/pos.js"></script>
<script src="js/map.js"></script>

<script src="js/ors-config.js"></script>
<script src="js/navRoutes.js"></script>
  
<script src="js/hg_unlocks.js"></script>
<script src="js/quizzes.js"></script>
<script src="js/quiz-audit.js"></script>
<!-- app.js f√∏r routes (eier HG_POS/getPos) -->

  
<script src="js/app.js"></script>

  
<script>
/* =========================
   Nearby UI wiring (tabs/search/status)
   ========================= */
(function () {
  // --- tabs: styrer eksisterende select og trigger app.js sin change-handler ---
  function bindTabs() {
    const sel = document.getElementById("leftPanelMode");
    if (!sel) return;

function showPanel(mode){
  const ids = ["panelNearby","panelRoutes","panelBadges","panelNature","panelPeople"];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });

  const map = {
    nearby: "panelNearby",
    routes: "panelRoutes",
    badges: "panelBadges",
    nature: "panelNature",
    people: "panelPeople"
  };

  const target = document.getElementById(map[mode] || "panelNearby");
  if (target) target.style.display = "";
}rt
    
    document.querySelectorAll(".nearby-tab").forEach(btn => {
      btn.addEventListener("click", () => {
        const mode = btn.getAttribute("data-leftmode") || "nearby";
        sel.value = mode;
        sel.dispatchEvent(new Event("change", { bubbles: true }));
        showPanel(mode);
        
        document.querySelectorAll(".nearby-tab").forEach(b => {
          b.classList.toggle("is-active", b === btn);
        });
      });
    });
  }

  // --- geo status: lytt p√• pos.js sitt hg:geo-event ---
  function setGeo(status) {
    const el = document.getElementById("geoStatus");
    if (!el) return;

    el.classList.remove("geo-ok","geo-bad","geo-unknown");

    if (status === "granted" || status === "test") {
      el.classList.add("geo-ok"); el.textContent = "üìç";
    } else if (status === "blocked" || status === "unsupported") {
      el.classList.add("geo-bad"); el.textContent = "‚õî";
    } else {
      el.classList.add("geo-unknown"); el.textContent = "‚Ä¶";
    }t
  }

  window.addEventListener("hg:geo", (e) => {
    const st = e?.detail?.status || "unknown";
    setGeo(st);
  });


 // --- post-prosess etter render: badge opp√• thumb + sikre horisontal strip + navn over dist ---
function patchRenderNearbyPlaces() {
  if (typeof window.renderNearbyPlaces !== "function") return;
  if (window.__hg_orig_renderNearbyPlaces) return;

  window.__hg_orig_renderNearbyPlaces = window.renderNearbyPlaces;
  window.renderNearbyPlaces = function () {
    window.__hg_orig_renderNearbyPlaces();

    const list = document.getElementById("nearbyList");
    if (!list) return;
    list.classList.add("nearby-strip");

    list.querySelectorAll(".nearby-item").forEach(item => {
      // 1) badge opp√• bildet: wrap thumb+badge hvis de finnes
      const thumb = item.querySelector(".nearby-thumb");
      const badge = item.querySelector(".nearby-badge");

      if (thumb && !(thumb.parentElement && thumb.parentElement.classList.contains("nearby-thumbWrap"))) {
        const wrap = document.createElement("div");
        wrap.className = "nearby-thumbWrap";

        thumb.parentElement.insertBefore(wrap, thumb);
        wrap.appendChild(thumb);
        if (badge) wrap.appendChild(badge);
      }

      // 2) navn + dist i en tekst-kolonne (2 linjer ved siden av bildet)
      const name = item.querySelector(".nearby-name");
      const dist = item.querySelector(".nearby-dist");

      if (name && dist && !(name.parentElement && name.parentElement.classList.contains("nearby-text"))) {
        const tw = document.createElement("div");
        tw.className = "nearby-text";

        name.parentElement.insertBefore(tw, name);
        tw.appendChild(name);
        tw.appendChild(dist);
      }
    });
  };
}

  // init
  showPanel(sel.value || "nearby");
  bindTabs();
  patchRenderNearbyPlaces();

  // set initial geo icon hvis state allerede finnes
  if (window.HG_POS && window.HG_POS.status) setGeo(window.HG_POS.status);
})();
</script>


<script src="js/routes.js"></script>
</body>
</html>
