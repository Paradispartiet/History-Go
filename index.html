<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>History Go</title>

  <!-- CSS -->
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/search.css">
  <link rel="stylesheet" href="css/nearby.css">
  <link rel="stylesheet" href="css/miniProfile.css">
  <link rel="stylesheet" href="css/profile.css">
  <link rel="stylesheet" href="css/merits.css">
  <link rel="stylesheet" href="css/quiz.css">
  <link rel="stylesheet" href="css/popups.css">
  <link rel="stylesheet" href="css/overlay.css">
  <link rel="stylesheet" href="css/effects.css">
  <link rel="stylesheet" href="css/map.css">
  <link rel="stylesheet" href="css/placeCard.css">
  <link rel="stylesheet" href="css/sheets.css">

  <!-- Console CSS -->
  <link rel="stylesheet" href="js/console/console.css">

</head>

<body class="hg-app">

  <!-- Toast -->
  <div id="toast"></div>

  <!-- USYNLIGE DATA-CONTAINERE -->
  <div id="collectionGrid" style="display:none"></div>
  <div id="collectionCount" style="display:none"></div>
  <div id="gallery" style="display:none"></div>

  <!-- Badge-modal -->
  <div id="badgeModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content">
      <img class="badge-img" src="" alt="Merke">
      <h3 class="badge-title"></h3>
      <p class="badge-level"></p>
      <div class="badge-progress"><div class="badge-progress-bar"></div></div>
      <p class="badge-progress-text"></p>
      <ul class="badge-quizzes"></ul>
      <button class="close-btn">Lukk</button>
    </div>
  </div>

<div class="app-shell">
  
  <!-- KART -->
  <div id="map" aria-label="Kart"></div>

  <div class="map-controls">
    <button id="btnCenter" title="Sentrer">âŒ–</button>
    <button id="btnExitMap" title="Lukk kart" aria-label="Lukk kart">âœ•</button>
  </div>

<!-- HEADER -->
<header class="site-header">

  <img class="hg-brand" src="bilder/logo_historygo.PNG" alt="History GO">
  
  <div class="top-actions">

<a id="miniProfile" class="miniProfileTop" href="profile.html" aria-label="Profil">
  <!-- Kun dette skal synes i topplinja -->
  <span id="miniName" class="mpt-name">Utforsker #182</span>

  <span class="mpt-badges" aria-label="Merker">
    <span class="mpt-badgeIcon" aria-hidden="true"></span>
    <!-- behold id=linkBadges sÃ¥ eksisterende JS fortsatt treffer -->
    <span id="linkBadges" class="mpt-count">0</span>
  </span>

  <!-- ALT under her beholdes for ikke Ã¥ miste ting, men skjules i topplinja -->
  <div class="mp-extra" aria-hidden="true">
    <p id="miniStats" class="muted">
      <span id="linkPlaces" class="linkish">0 steder</span>
      <span id="linkQuiz" class="linkish">0 quizzer</span>
    </p>

    <div id="miniBadges" class="profile-badges"></div>

    <div id="miniLastQuiz" class="profile-last-quiz" style="display:none;">
      <img id="miniLastQuizImg" src="">
      <span id="miniLastQuizName"></span>
    </div>
  </div>
</a>
    
    <button id="btnSeeMap" class="iconbtn" type="button" aria-label="Kartmodus" title="Kartmodus">âŒ–</button>

    <input id="globalSearch" type="search" placeholder="SÃ¸kâ€¦" autocomplete="off">

    <span id="geoStatus" class="geo-status geo-unknown" title="Posisjonstatus">â€¦</span>

    <button id="btnUnlockAll" class="iconbtn" type="button" aria-label="Unlock all" title="Unlock all">ðŸ”“</button>
      
    <label class="toggle">
      <input id="openToggle" type="checkbox" />
      <span></span>
    </label>
  </div>

  <!-- SÃ˜KERESULTATER (ligger fortsatt i headeren, men kan styles til Ã¥ droppe ned) -->
  <div id="searchResults"></div>

</header>


  <!-- VENSTRE RAMMEPANEL -->
<div id="nearbyListContainer" class="leftpanel">

  <div class="leftpanel-head">
    <div class="leftpanel-title">Utforsk</div>

    <div class="nearby-row1">
      <div class="nearby-tabs" role="tablist" aria-label="Utforsk">

        <!-- FILTER-IKON -->
        <button id="nearbyFilterBtn"
                class="nearby-filter-icon"
                type="button"
                aria-label="Filter"></button>

        <!-- TABBER -->
        <button class="nearby-tab is-active"
                data-leftmode="nearby"
                type="button">Steder</button>

        <button class="nearby-tab"
                data-leftmode="people"
                type="button">Folk</button>

        <button class="nearby-tab"
                data-leftmode="nature"
                type="button">Natur</button>

        <button class="nearby-tab"
                data-leftmode="routes"
                type="button">Ruter</button>

        <button class="nearby-tab"
                data-leftmode="badges"
                type="button">Merker</button>

      </div>

      <!-- skjult select -->
      <select id="leftPanelMode"
              class="leftpanel-select"
              aria-label="Velg visning"
              style="display:none">
        <option value="nearby" selected>NÃ¦rmeste</option>
        <option value="people">Folk</option>
        <option value="nature">Natur</option>
        <option value="routes">Ruter</option>
        <option value="badges">Merker</option>
      </select>

    </div>
  </div>

  <div class="leftpanel-body">  <!-- 1) NÃ¦rmeste -->
  <section id="panelNearby" class="leftpanel-view">
    <!-- status beholdes for logging/feilsÃ¸k, men skjules visuelt -->
    <div id="status" class="muted" style="display:none">Henter posisjonâ€¦</div>

    <div class="nearby-row2">
      <div id="nearbyList" class="nearby-strip"></div>
    </div>
  </section>

<!-- 2) People -->
<section id="panelPeople" class="leftpanel-view" style="display:none;">
  <div class="leftpanel-hint muted">People (kommer).</div>
  <div id="leftPeopleList" class="leftpanel-list"></div>
</section>

<!-- 3) Natur -->
<section id="panelNature" class="leftpanel-view" style="display:none;">
  <div class="leftpanel-hint muted">Natur (kommer).</div>
  <div id="leftNatureList" class="leftpanel-list"></div>
</section>
    
  <!-- 4) Ruter -->
  <section id="panelRoutes" class="leftpanel-view" style="display:none;">
    <div class="leftpanel-hint muted">Velg en rute, eller Ã¥pne rutearket.</div>
    <button class="chip ghost" onclick="openRoutesSheet()">Ã…pne ruter</button>
    <div id="leftRoutesList" class="leftpanel-list"></div>
  </section>
    
  <!-- 5) Merker -->
  <section id="panelBadges" class="leftpanel-view" style="display:none;">
    <div class="leftpanel-hint muted">Velg en kategori.</div>
    <div id="leftBadgesList" class="leftpanel-list"></div>
  </section>

  
  </div>
</div>
  
  <!-- PLACE CARD -->
<div id="placeCard" aria-hidden="true">
  <div class="pc-body">

<div class="pc-main">

  <!-- Tekst fÃ¸rst -->
  <div class="pc-text">
    <h2 id="pcTitle"></h2>
    <div id="pcMeta" class="pc-meta"></div>
    <p id="pcDesc" class="pc-desc"></p>
  </div>

  <!-- Ikoner pÃ¥ samme nivÃ¥ som bilde -->
  <div class="pc-icons">
    <div id="pcPeopleIcon" class="pc-round" data-toggle="people"></div>
    <div id="pcNatureIcon" class="pc-round" data-toggle="nature"></div>
    <div id="pcBadgesIcon" class="pc-round" data-toggle="badges"></div>
  </div>

  <!-- Bilde nederst -->
  <img id="pcImage" class="pc-img" src="" alt="">
</div>

<div class="pc-lists">
    <!-- PEOPLE LIST -->
  <div id="pcPeopleList" class="pc-list pc-people">
    <!-- JS fyller denne med personer -->
  </div>

    <!-- NATURE LIST -->
  <div id="pcNatureList" class="pc-list pc-nature-list">
  <!-- JS fyller denne med flora / fauna -->
  </div>

    <!-- BADGES LIST -->
  <div id="pcBadgesList" class="pc-list pc-badges-list">
    <!-- JS fyller denne med merker -->
  </div>
</div>
    
<!-- FAST BUNN -->
<div class="pc-footer">

  <div class="pc-actions">
    <button id="pcInfo"   class="secondary">Mer info</button>
    <button id="pcQuiz"   class="primary">Ta quiz</button>
    <button id="pcUnlock" class="primary">LÃ¥s opp</button>

    <button id="pcRoute"   class="ghost pc-iconbtn" aria-label="Rute" title="Rute"></button>
    <button id="pcObserve" class="ghost pc-iconbtn" aria-label="Observasjon" title="Observasjon"></button>
    <button id="pcNote"    class="ghost pc-iconbtn" aria-label="Notat" title="Notat"></button>

    <div class="brand brand-icononly">
      <img class="brand-logo" src="bilder/logo_historygo.PNG" alt="History GO">
    </div>
  </div>

  <!-- Mini-wonderkammer / NextUp â€“ helt nederst -->
  <div id="mpNextUp" class="pc-nextup pc-nextup--bottom"></div>

</div>

  </div> <!-- /.pc-body -->
</div>   <!-- /#placeCard -->

 </div> <!-- /app-shell --> 

  
  <!-- SERVICE WORKER -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        const base = location.pathname.replace(/\/[^\/]*$/, "/");
        navigator.serviceWorker.register(base + "sw.js");
      });
    }
  </script>


  
  <!-- MapLibre JS: MÃ… fÃ¸r map.js -->
<link
  href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
  rel="stylesheet"
/>

<script
  src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"
  crossorigin="anonymous">
</script>

<script>
  window.addEventListener("error", (e) => {
    console.log("[GLOBAL ERROR]", {
      message: e.message,
      filename: e.filename,
      lineno: e.lineno,
      colno: e.colno
    });
  });

  window.addEventListener("unhandledrejection", (e) => {
    console.log("[UNHANDLED REJECTION]", e.reason);
  });

</script>

<!-- ======================================================
     EKSTERNE / STÃ˜TTE
====================================================== -->
<script src="js/ui/popup-utils.js"></script>
<script src="js/ui/place-card.js"></script>
<script src="js/hgchips.js" defer></script>

<script src="js/knowledge.js"></script>
<script src="js/knowledge_component.js"></script>
<script src="js/trivia.js"></script>
<script src="js/hgInsights.js"></script>
<script src="js/dataHub.js"></script>

<script src="js/domainRegistry.js"></script>
<script src="js/domainHealthReport.js"></script>

<!-- ======================================================
     DEV / CONSOLE
====================================================== -->
<script src="js/console/init.js"></script>
<script src="js/console/verify.js"></script>
<script src="js/console/diagnosticConsole.js"></script>
<script src="js/console/devConsole.js"></script>
<script src="js/console/legacyExtensions.js"></script>

<script src="js/audits/missingImages.audit.js"></script>

<!-- ======================================================
     OBSERVATIONS
====================================================== -->
<script src="js/observations.js"></script>
<script src="js/observationsView.js"></script>

<!-- ======================================================
     CORE (ingen DOM, ingen side-effekter)
====================================================== -->
<script src="js/core/state.js"></script>
<script src="js/core/persistence.js"></script>
<script src="js/core/openmode.js"></script>
<script src="js/core/core.js"></script>
<script src="js/core/categories.js"></script>
<script src="js/core/badges.js"></script>
<script src="js/core/tiersCivi.js"></script>

<script src="js/core/geo.js"></script>
<script src="js/ui/geo-indicator.js"></script>

<!-- ======================================================
     GEO / MAP
====================================================== -->
<script src="js/core/pos.js"></script>
<script src="js/map.js"></script>

<script src="js/ors-config.js"></script>
<script src="js/navRoutes.js"></script>

<!-- ======================================================
     GAME / PROGRESSION
====================================================== -->
<script src="js/hg_unlocks.js"></script>
<script src="js/quizzes.js"></script>
<script src="js/quiz-audit.js"></script>

<!-- ======================================================
     UI â€“ DOM + INTERAKSJON
====================================================== -->
<script src="js/ui/dom.js"></script>
<script src="js/ui/toast.js"></script>

<script src="js/ui/events.js"></script>
<script src="js/ui/interactions.js"></script>
<script src="js/ui/lists.js"></script>

<script src="js/ui/left-panel.js"></script>
<script src="js/ui/badges.js"></script>
<script src="js/ui/badge-modal.js"></script>
<script src="js/ui/mini-profile.js"></script>
<script src="js/ui/civication-inbox.js"></script>

<!-- ======================================================
     BOOT (kobler alt)
====================================================== -->
<script src="js/boot.js"></script>

<!-- ======================================================
     APP â€“ SIST, ALLTID
====================================================== -->
<script src="js/app.js"></script>

  
  <script>
    // Tving linkBadges til Ã¥ vÃ¦re kun tall (app.js kan skrive "12 merker")
  (function(){
    const el = document.getElementById("linkBadges");
    if(!el) return;

    function normalize(){
      const txt = (el.textContent || "").trim();
      const m = txt.match(/\d+/);
      el.textContent = m ? m[0] : "0";
    }

    // run now + hold it stable hvis app.js endrer igjen
    normalize();
    const obs = new MutationObserver(normalize);
    obs.observe(el, { childList:true, characterData:true, subtree:true });
  })();
</script>

<script>


  function setGeo(status) {
    const el = document.getElementById("geoStatus");
    if (!el) return;

    el.classList.remove("geo-ok","geo-bad","geo-unknown");

    if (status === "granted" || status === "test") {
      el.classList.add("geo-ok"); el.textContent = "ðŸ“";
    } else if (status === "blocked" || status === "unsupported") {
      el.classList.add("geo-bad"); el.textContent = "â›”";
    } else {
      el.classList.add("geo-unknown"); el.textContent = "â€¦";
    }
  }

  window.addEventListener("hg:geo", (e) => {
    const st = e?.detail?.status || "unknown";
    setGeo(st);
  });


</script>


<script src="js/routes.js"></script>
</body>
</html>
