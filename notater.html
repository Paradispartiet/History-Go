<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <title>History Go – Mine notater</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/theme.css">
</head>
<body>

  <main class="main">
    <header style="margin-bottom:1rem;">
      <a href="profile.html" style="color:var(--muted); text-decoration:none;">← Tilbake til profilen</a>
      <h1>Mine notater</h1>
<p class="muted">
  Her ser du notater du har skrevet i History Go – om personer, steder og andre ting du vil huske.
</p>
    </header>

    <section id="notesRoot">
      <p class="muted">Laster notater …</p>
    </section>
  </main>

   <script>
    function loadNotes() {
      const root = document.getElementById("notesRoot");
      let notes = [];
      try {
        const raw = localStorage.getItem("hg_user_notes_v1");
        notes = raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.warn("Kunne ikke lese notater", e);
      }

      if (!Array.isArray(notes) || !notes.length) {
        root.innerHTML = "<p class='muted'>Du har ingen notater ennå.</p>";
        return;
      }

      // sortér nyeste først
      notes.sort((a, b) => (b.createdAt || "").localeCompare(a.createdAt || ""));

      // hent både personer og steder, slik at vi kan vise kontekst
      Promise.all([
        fetch("people.json").then(r => r.json()).catch(() => []),
        fetch("places.json").then(r => r.json()).catch(() => [])
      ])
        .then(([people, places]) => {
          const peopleMap = {};
          (people || []).forEach(p => { if (p && p.id) peopleMap[p.id] = p.name; });

          const placesMap = {};
          (places || []).forEach(pl => { if (pl && pl.id) placesMap[pl.id] = pl.name; });

          renderNotes(root, notes, peopleMap, placesMap);
        })
        .catch(() => {
          renderNotes(root, notes, {}, {});
        });
    }

    function renderNotes(root, notes, peopleMap, placesMap) {
      const cards = notes.map(n => {
        const personName = n.personId ? (peopleMap[n.personId] || "Ukjent person") : null;
        const placeName = n.placeId ? (placesMap[n.placeId] || "Ukjent sted") : null;
        const contextName = personName || placeName || "Notat";

        const date = n.createdAt ? new Date(n.createdAt).toLocaleString("no-NO") : "";
        const typeLabelRaw =
          n.type || (n.personId ? "person" : (n.placeId ? "place" : "note"));
        const typeLabel = typeLabelRaw ? String(typeLabelRaw).toUpperCase() : "";
        const catLabel = n.categoryId ? String(n.categoryId).toUpperCase() : "";
        const feelingLabel = n.feeling ? String(n.feeling) : "";

        const metaParts = [];
        if (contextName) metaParts.push(contextName);
        if (catLabel) metaParts.push(catLabel);
        if (typeLabel) metaParts.push(typeLabel);
        if (feelingLabel) metaParts.push(feelingLabel);
        if (date) metaParts.push(date);

        return `
          <article class="card">
            <div class="row between">
              <div>
                <div class="name">${escapeHtml(n.title || contextName)}</div>
                <div class="meta">
                  ${escapeHtml(metaParts.join(" · "))}
                </div>
              </div>
            </div>
            <p style="margin-top:8px;">${escapeHtml(n.text || "")}</p>
          </article>
        `;
      }).join("");

      root.innerHTML = `
        <section class="cards">
          ${cards}
        </section>
      `;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    document.addEventListener("DOMContentLoaded", loadNotes);
  </script>

</body>
</html>
