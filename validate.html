<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Datavalidering ‚Ä¢ History Go</title>
  <style>
    :root{--bg:#0b1620;--panel:#0f1f2d;--ok:#2ecc71;--warn:#f1c40f;--err:#e74c3c;--muted:#9fb0c3}
    html,body{background:var(--bg);color:#eaf2fd;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;margin:0}
    header{display:flex;gap:12px;align-items:center;padding:16px 18px;border-bottom:1px solid #11283b}
    header h1{font-size:20px;margin:0;font-weight:700}
    main{padding:18px;max-width:940px;margin:0 auto}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:#0c2436;border:1px solid #10314a;color:#cfe5ff;padding:8px 12px;border-radius:999px;font-size:14px}
    .pill.ok{background:#0f2a1f;border-color:#1b7a4a;color:#baf7d3}
    .pill.warn{background:#302900;border-color:#8a6d00;color:#ffe07d}
    .pill.err{background:#2a0e10;border-color:#7a1f25;color:#ffb3bc}
    section{background:var(--panel);border:1px solid #11283b;border-radius:14px;margin:16px 0}
    section h2{margin:0;padding:14px 16px;border-bottom:1px solid #11283b;font-size:16px}
    .body{padding:14px 16px}
    details{background:#0b2132;border:1px solid #0e2a41;border-radius:10px;margin:10px 0}
    details>summary{cursor:pointer;padding:10px 12px;color:#d2e7ff}
    .list{padding:10px 14px;border-top:1px solid #0e2a41}
    ul{margin:0;padding-left:18px}
    .muted{color:var(--muted)}
    code{background:#08141d;border:1px solid #0f2a41;padding:2px 6px;border-radius:6px}
    a{color:#8ec6ff}
  </style>
</head>
<body>
<header>
  <h1>Valider data</h1>
  <div class="row">
    <span id="pill-places"  class="pill">places.json</span>
    <span id="pill-people"  class="pill">people.json</span>
    <span id="pill-quizzes" class="pill">quizzes.json</span>
  </div>
  <div class="row" style="margin-left:auto">
    <span id="pill-ok"   class="pill ok">OK: 0</span>
    <span id="pill-warn" class="pill warn">Advarsler: 0</span>
    <span id="pill-err"  class="pill err">Feil: 0</span>
  </div>
</header>

<main>
  <section>
    <h2>Oppsummering</h2>
    <div class="body">
      <div class="row">
        <span class="pill" id="sum-places">Steder: ‚Äì</span>
        <span class="pill" id="sum-people">Personer: ‚Äì</span>
        <span class="pill" id="sum-quizzes">Quizzer: ‚Äì</span>
      </div>
      <p class="muted" style="margin-top:10px">
        Sjekker: unik <code>id</code>, gyldig <code>lat/lon</code>, <code>category</code>, 
        <code>people[].placeId ‚Üí places[].id</code>, <code>quizzes[].personId ‚Üí people[].id</code>.
        Objekter med feltet <code>note</code> i <code>people.json</code> telles som notater, ikke personer.
      </p>
    </div>
  </section>

  <section>
    <h2>JSON-syntaks</h2>
    <div class="body" id="syntax">Alt ser greit ut.</div>
  </section>

  <section>
    <h2>Relasjoner & felt</h2>
    <div class="body" id="relations">Kj√∏rer sjekker‚Ä¶</div>
  </section>

  <section>
    <h2>Detaljer</h2>
    <div class="body">
      <details>
        <summary>Lister: Places</summary>
        <div class="list" id="list-places"></div>
      </details>
      <details>
        <summary>Lister: People</summary>
        <div class="list" id="list-people"></div>
      </details>
      <details>
        <summary>Notater i people.json</summary>
        <div class="list" id="list-notes"></div>
      </details>
      <details>
        <summary>Lister: Quizzes</summary>
        <div class="list" id="list-quizzes"></div>
      </details>
      <details>
        <summary>Feil / advarsler</summary>
        <div class="list" id="list-issues"></div>
      </details>
    </div>
  </section>
</main>

<script>
(async function(){
  const issues = [];
  const warns  = [];

  async function getJSON(path){
    const r = await fetch(path, {cache:"no-store"});
    const t = await r.text();
    try { return JSON.parse(t); }
    catch(e){
      const line = t.split('\n').findIndex(s => s.includes('"note"'))+1;
      issues.push(`Kunne ikke parse ${path}. Sjekk komma/JSON. ${e.message}`);
      document.getElementById('syntax').innerHTML =
        `<span class="pill err">‚ùå ${path}</span> ‚Äì JSON-feil.`;
      throw e;
    }
  }

  // last inn
  const [places, peopleRaw, quizzes] = await Promise.all([
    getJSON('places.json'),
    getJSON('people.json'),
    getJSON('quizzes.json')
  ]);

  // splitt people: notater vs personer
  const notes  = peopleRaw.filter(p => 'note' in p);
  const people = peopleRaw.filter(p => !('note' in p));

  // summering
  const setText = (id, txt) => document.getElementById(id).textContent = txt;
  setText('sum-places',  `Steder: ${places.length}`);
  setText('sum-people',  `Personer: ${people.length}`);
  setText('sum-quizzes', `Quizzer: ${quizzes.length}`);

  // piller for filer (bare ‚Äúlastet‚Äù status)
  document.getElementById('pill-places').classList.add('ok');
  document.getElementById('pill-people').classList.add('ok');
  document.getElementById('pill-quizzes').classList.add('ok');

  // hjelpeoppslag
  const placeIds = new Set(places.map(p=>p.id));
  const peopleIds= new Set(people.map(p=>p.id));
  const catSet   = new Set(places.map(p=>p.category));
  const seenIds  = new Set();

  // ‚Äî‚Äî‚Äî places
  places.forEach(p=>{
    // unik id
    if(seenIds.has(p.id)) issues.push(`Duplikat id i places: ${p.id}`);
    seenIds.add(p.id);

    // lat/lon
    const latOk = typeof p.lat==='number' && p.lat>=-90 && p.lat<=90;
    const lonOk = typeof p.lon==='number' && p.lon>=-180 && p.lon<=180;
    if(!latOk || !lonOk) issues.push(`Ugyldig koordinat for place ${p.id} (${p.lat}, ${p.lon})`);

    // kategori
    if(!p.category || typeof p.category!=='string') warns.push(`Manglende/ugyldig category p√• ${p.id}`);
  });

  // ‚Äî‚Äî‚Äî people
  seenIds.clear();
  people.forEach(pr=>{
    if(seenIds.has(pr.id)) issues.push(`Duplikat id i people: ${pr.id}`);
    seenIds.add(pr.id);

    // koordinater: valgfritt dersom placeId finnes
    const hasCoords = typeof pr.lat==='number' && typeof pr.lon==='number';
    if(!hasCoords){
      if(!placeIds.has(pr.placeId)) issues.push(`Person ${pr.id} mangler koordinater og har ukjent placeId=${pr.placeId}`);
    } else {
      const latOk = pr.lat>=-90 && pr.lat<=90;
      const lonOk = pr.lon>=-180 && pr.lon<=180;
      if(!latOk || !lonOk) issues.push(`Ugyldig koordinat for person ${pr.id} (${pr.lat}, ${pr.lon})`);
    }
    if(pr.placeId && !placeIds.has(pr.placeId)) issues.push(`Ukjent placeId for person ${pr.id}: ${pr.placeId}`);
  });

  // ‚Äî‚Äî‚Äî quizzes
  seenIds.clear();
  quizzes.forEach(q=>{
    if(seenIds.has(q.id)) issues.push(`Duplikat id i quizzes: ${q.id}`);
    seenIds.add(q.id);
    if(!peopleIds.has(q.personId)) issues.push(`Quiz ${q.id} peker til ukjent personId=${q.personId}`);
    if(!q.questions || !Array.isArray(q.questions) || q.questions.length===0){
      issues.push(`Quiz ${q.id} mangler questions`);
    }
  });

  // render lister
  const ul = arr => `<ul>${arr.map(x=>`<li>${x}</li>`).join('')}</ul>`;
  document.getElementById('list-places').innerHTML  = ul(places.map(p=>`${p.id} ‚Äî ${p.name}`));
  document.getElementById('list-people').innerHTML  = ul(people.map(p=>`${p.id} ‚Äî ${p.name}`));
  document.getElementById('list-notes').innerHTML   = notes.length ? ul(notes.map(n=>n.note)) : `<span class="muted">Ingen notater.</span>`;
  document.getElementById('list-quizzes').innerHTML = ul(quizzes.map(q=>`${q.id} ‚Üí personId=${q.personId}`));

  // relasjonstekst
  const rel = [];
  rel.push(`Kategorier oppdaget (${catSet.size}): ${[...catSet].join(', ')}`);
  rel.push(`Alle people.placeId finnes i places: ${people.every(p=>!p.placeId || placeIds.has(p.placeId)) ? 'JA' : 'NEI'}`);
  rel.push(`Alle quizzes.personId finnes i people: ${quizzes.every(q=>peopleIds.has(q.personId)) ? 'JA' : 'NEI'}`);
  document.getElementById('relations').innerHTML = ul(rel);

  // issues/warns
  document.getElementById('list-issues').innerHTML =
    (!issues.length && !warns.length)
      ? `<span class="muted">Ingen feil eller advarsler üéâ</span>`
      : (issues.length ? `<h4>Feil</h4>${ul(issues)}` : '') + (warns.length ? `<h4>Advarsler</h4>${ul(warns)}` : '');

  // topp-pills
  document.getElementById('pill-err').textContent  = `Feil: ${issues.length}`;
  document.getElementById('pill-warn').textContent = `Advarsler: ${warns.length}`;
  const okCount = (issues.length===0)?1:0;
  document.getElementById('pill-ok').textContent   = `OK: ${okCount}`;
})();
</script>
</body>
</html>
